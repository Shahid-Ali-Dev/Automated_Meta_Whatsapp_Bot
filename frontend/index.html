<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Marketing Bot</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden m-4">
        
        <div class="bg-green-600 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold"><i class="fab fa-whatsapp"></i> Marketing Bot</h1>
                <p class="text-green-100 text-sm mt-1">Status: <span id="system-status" class="font-bold">Connecting...</span></p>
            </div>
            <div class="bg-green-700 p-2 rounded-lg">
                <i class="fas fa-robot text-2xl"></i>
            </div>
        </div>

        <div class="p-8 space-y-6">

            <div class="group opacity-75">
                <label class="block text-gray-700 font-bold mb-2">
                    <i class="fas fa-lock text-green-600 mr-2"></i> Google Sheet Source
                </label>
                <div class="relative">
                    <input type="text" disabled value="üîí Linked to Default Server Sheet" 
                        class="w-full p-3 border border-gray-200 bg-gray-100 text-gray-500 rounded-lg cursor-not-allowed focus:outline-none"
                    >
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                        <span class="text-xs text-green-600 font-semibold bg-green-100 px-2 py-1 rounded">Configured</span>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-gray-700 font-bold">
                        <i class="fas fa-table text-green-600 mr-2"></i> Select Tables (Tabs)
                    </label>
                    <button onclick="loadSheetNames()" class="text-xs text-blue-600 hover:text-blue-800 underline">
                        <i class="fas fa-sync"></i> Refresh List
                    </button>
                </div>

                <div id="sheetListContainer" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto p-2 bg-white border border-gray-300 rounded">
                    <p class="text-xs text-gray-400 col-span-3">Loading sheets...</p>
                </div>
            </div>

            <div>
                <label class="block text-gray-700 font-bold mb-2">
                    <i class="fas fa-image text-green-600"></i> Image URL (Optional)
                </label>
                <input type="text" id="imageUrl" 
                    placeholder="https://your-website.com/image.jpg" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                >
            </div>

            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                <label class="block text-gray-700 font-bold mb-3">
                    <i class="fas fa-bullhorn text-blue-600"></i> Select Channels
                </label>
                <div class="flex gap-6">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="checkWhatsapp" class="form-checkbox h-5 w-5 text-green-600 rounded focus:ring-green-500">
                        <span class="text-gray-700 font-medium">WhatsApp</span>
                    </label>

                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="checkEmail" class="form-checkbox h-5 w-5 text-red-500 rounded focus:ring-red-400">
                        <span class="text-gray-700 font-medium">Email</span>
                    </label>
                </div>
            </div>

            <div>
                <label class="block text-gray-700 font-bold mb-2">
                    <i class="fas fa-comment-alt text-green-600"></i> Message Body
                </label>
                <textarea id="messageBody" rows="4" 
                    placeholder="Type your message here..." 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition"
                ></textarea>
                <p class="text-xs text-right text-gray-400">Formatting: *Bold*, _Italic_ supported.</p>
            </div>

            <hr class="border-gray-200">

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <label class="block text-gray-700 font-bold mb-2">
                    <i class="fas fa-lock text-red-500"></i> Admin Confirmation
                </label>
                
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="password" id="adminPassword" 
                        placeholder="Enter Admin Password" 
                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400"
                    >
                    <button id="sendBtn" onclick="askConfirmation()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform transition hover:scale-105 flex items-center justify-center gap-2">
                        <span>SEND BLAST</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <div id="outputLog" class="hidden mt-4 p-4 rounded-lg bg-gray-100 text-sm font-mono border border-gray-300 max-h-40 overflow-y-auto">
                <p class="text-gray-500">Waiting for command...</p>
            </div>

        </div>
    </div>

    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform scale-95 border border-gray-100">
            <div class="text-center">
                <div id="modalIconBg" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                    <i id="modalIcon" class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2" id="modalTitle">Title</h3>
                <p class="text-gray-500 text-sm mb-6" id="modalMessage">Message</p>
                <button onclick="closeModal()" class="w-full inline-flex justify-center rounded-xl shadow-lg px-4 py-3 bg-gray-900 text-white font-bold hover:bg-gray-800 transition">
                    Got it
                </button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform border-t-4 border-yellow-400">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-100 mb-4 animate-pulse">
                    <i class="fas fa-question text-yellow-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Confirm Blast?</h3>
                <p class="text-gray-500 text-sm mb-6">
                    You are about to send messages via: <br>
                    <span id="confirmChannels" class="font-bold text-gray-800"></span>
                    <br><br>
                    This action cannot be undone.
                </p>
                
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-700 font-bold hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="executeBlast()" class="flex-1 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg transition transform hover:-translate-y-1">
                        Yes, Send üöÄ
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    const BACKEND_URL = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost")
        ? "http://127.0.0.1:5000"
        : "https://automated-meta-whatsapp-bot.onrender.com";

    // --- MODAL UTILS ---
    function showModal(title, message, isError = true) {
        const modal = document.getElementById('customModal');
        const icon = document.getElementById('modalIcon');
        const iconBg = document.getElementById('modalIconBg');
        
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = message;

        if (isError) {
            icon.className = "fas fa-exclamation-triangle text-red-600 text-2xl";
            iconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4";
        } else {
            icon.className = "fas fa-check text-green-600 text-2xl";
            iconBg.className = "mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4";
        }
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeModal() {
        document.getElementById('customModal').classList.add('hidden');
        document.getElementById('customModal').classList.remove('flex');
    }

    // --- CONFIRMATION UTILS ---
    function askConfirmation() {
        const message = document.getElementById('messageBody').value;
        const password = document.getElementById('adminPassword').value;
        const useWhatsapp = document.getElementById('checkWhatsapp').checked;
        const useEmail = document.getElementById('checkEmail').checked;

        // 1. Validate First
        if (!message || !password) {
            showModal("Missing Fields", "Please enter Message and Password.", true);
            return;
        }
        if (!useWhatsapp && !useEmail) {
            showModal("Selection Error", "Please select at least one channel.", true);
            return;
        }

        // 2. Set Text based on selection
        let channelText = "";
        if (useWhatsapp && useEmail) channelText = "‚úÖ WhatsApp and ‚úÖ Email";
        else if (useWhatsapp) channelText = "‚úÖ WhatsApp Only";
        else if (useEmail) channelText = "‚úÖ Email Only";

        document.getElementById('confirmChannels').innerText = channelText;

        // 3. Show Confirmation Modal
        const modal = document.getElementById('confirmModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // --- CLEANUP FUNCTION (Wipes Form) ---
    function resetForm() {
        // Clear inputs so you don't accidentally send again
        document.getElementById('messageBody').value = "";
        document.getElementById('adminPassword').value = "";
        document.getElementById('imageUrl').value = "";
        document.getElementById('checkWhatsapp').checked = false;
        document.getElementById('checkEmail').checked = false;
        
        // WE DELETED THE TIMEOUT CODE HERE.
        // The logs will now stay visible forever until you refresh the page.
    }

    // --- MAIN LOGIC ---
    async function executeBlast() {
        closeConfirmModal(); 

        const btn = document.getElementById('sendBtn');
        const logDiv = document.getElementById('outputLog');
        
        // Lock UI
        btn.disabled = true;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sending...`;
        
        // GRAB SELECTED TABS
        const allCheckboxes = document.querySelectorAll('.sheet-checkbox:checked');
        let selectedTabs = [];
        allCheckboxes.forEach(cb => selectedTabs.push(cb.value));

        // Default to ALL if nothing selected
        if (selectedTabs.length === 0) selectedTabs = ["ALL"];

        // Grab other values
        const imageUrl = document.getElementById('imageUrl').value;
        const message = document.getElementById('messageBody').value;
        const password = document.getElementById('adminPassword').value;
        const useWhatsapp = document.getElementById('checkWhatsapp').checked;
        const useEmail = document.getElementById('checkEmail').checked;

        try {
            const response = await fetch(`${BACKEND_URL}/api/send-blast`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    password: password,
                    image_url: imageUrl,
                    send_whatsapp: useWhatsapp, 
                    send_email: useEmail,
                    selected_tabs: selectedTabs // <--- SEND THIS
                })
            });

            const data = await response.json();

            if (response.ok) {
                // 1. Build a clean stats summary string
                const stats = data.stats;
                const statsHtml = `
                    <div class="mt-2 pl-2 border-l-2 border-green-500 text-gray-300 text-xs">
                        <p><strong>Total Processed:</strong> ${data.total_rows}</p>
                        <hr class="border-gray-600 my-1">
                        <p>üü¢ WA Sent: ${stats.whatsapp_sent} <span class="text-red-400">(Failed: ${stats.whatsapp_fail})</span></p>
                        <p>üîµ Email Sent: ${stats.email_sent} <span class="text-red-400">(Failed: ${stats.email_fail})</span></p>
                    </div>
                `;

                // 2. Append this to the log
                logDiv.innerHTML += `
                    <p class="text-green-400 font-bold mt-2">> ‚úÖ BLAST COMPLETE!</p>
                    ${statsHtml}
                `;
                
                showModal("Blast Complete!", `Successfully processed ${data.total_rows} contacts. See logs for details.`, false);
                
                // 3. Reset form (but keep logs visible)
                resetForm();

            } else {
                logDiv.innerHTML += `<p class="text-red-500 font-bold mt-2">> ‚ùå ERROR: ${data.error}</p>`;
                showModal("Operation Failed", data.error, true);
            }

        } catch (error) {
            logDiv.innerHTML += `<p class="text-red-500 font-bold mt-2">> ‚ùå NETWORK ERROR</p>`;
            showModal("Network Error", "Could not connect to backend.", true);
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<span>SEND BLAST</span> <i class="fas fa-paper-plane"></i>`;
            btn.classList.remove("opacity-50", "cursor-not-allowed");
        }
    }

    // Status Check on Load
    window.onload = async () => {
        const statusSpan = document.getElementById('system-status');
        
        // 1. Check Backend Status
        try {
            const response = await fetch(`${BACKEND_URL}/`);
            if (response.ok) {
                statusSpan.innerText = "Online";
                statusSpan.className = "bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider";
            }
        } catch (error) {
            statusSpan.innerText = "Offline";
            statusSpan.className = "bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider";
        }
        
        // 2. Load Sheets
        // REMOVE THE LINE: checkStatus(); <--- CAUSING THE ERROR
        loadSheetNames(); 
    };
    // 2. FUNCTION TO FETCH SHEET NAMES
    async function loadSheetNames() {
        const container = document.getElementById('sheetListContainer');
        container.innerHTML = `<p class="text-xs text-gray-400 col-span-3"><i class="fas fa-spinner fa-spin"></i> Fetching tables...</p>`;
        
        try {
            const response = await fetch(`${BACKEND_URL}/api/get-sheet-names`);
            const data = await response.json();
            
            if (data.sheets && data.sheets.length > 0) {
                container.innerHTML = ""; // Clear loader
                
                // Add "Select All" Option
                const allHtml = `
                    <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                        <input type="checkbox" value="ALL" checked onchange="toggleSheetSelection(this)" class="sheet-checkbox form-checkbox h-4 w-4 text-green-600 rounded">
                        <span class="font-bold">Select All</span>
                    </label>
                `;
                container.innerHTML += allHtml;

                // Add Individual Sheets
                data.sheets.forEach(sheetName => {
                    const html = `
                        <label class="flex items-center space-x-2 text-sm cursor-pointer hover:bg-gray-50 p-1 rounded">
                            <input type="checkbox" value="${sheetName}" onchange="toggleSheetSelection(this)" class="sheet-checkbox form-checkbox h-4 w-4 text-green-600 rounded">
                            <span class="truncate" title="${sheetName}">${sheetName}</span>
                        </label>
                    `;
                    container.innerHTML += html;
                });
            } else {
                container.innerHTML = `<p class="text-xs text-red-400 col-span-3">No sheets found.</p>`;
            }
        } catch (e) {
            container.innerHTML = `<p class="text-xs text-red-400 col-span-3">Failed to load sheets.</p>`;
        }
    }
    // 3. LOGIC: Mutually Exclusive Selection
    function toggleSheetSelection(checkbox) {
        const allCheckbox = document.querySelector('.sheet-checkbox[value="ALL"]');
        const otherCheckboxes = document.querySelectorAll('.sheet-checkbox:not([value="ALL"])');

        if (checkbox.value === "ALL") {
            // If "Select All" is checked, uncheck everyone else
            if (checkbox.checked) {
                otherCheckboxes.forEach(cb => cb.checked = false);
            }
        } else {
            // If a specific sheet is checked, uncheck "Select All"
            if (checkbox.checked) {
                if (allCheckbox) allCheckbox.checked = false;
            }
        }
    }
</script>
</body>
</html>